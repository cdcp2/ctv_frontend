---
import Layout from '../../layouts/Layout.astro';
import { getArticle, getRelated, getArticleTags } from '../../lib/api';
import AdSlot from '../../components/AdSlot.astro';
import DisqusThread from '../../components/DisqusThread';
type Ad = {
  id: number;
  title: string;
  image_url?: string | null;
  target_url?: string | null;
  html_snippet?: string | null;
  position: string;
};

export const prerender = false;

const { slug } = Astro.params;
const disqusShortname = import.meta.env.PUBLIC_DISQUS_SHORTNAME || '';
const article = slug ? await getArticle(slug) : null;

if (!article) {
  return Astro.redirect('/'); // fallback simple
}

const [related, tags, adsMid, adsEnd] = await Promise.all([
  getRelated(slug!),
  getArticleTags(slug!),
  fetch(`${import.meta.env.PUBLIC_API_BASE || 'http://localhost:3000'}/api/ads?position=article_mid&limit=1`).then(r => r.ok ? r.json() as Promise<Ad[]> : []).catch(() => []) as Promise<Ad[]>,
  fetch(`${import.meta.env.PUBLIC_API_BASE || 'http://localhost:3000'}/api/ads?position=article_end&limit=1`).then(r => r.ok ? r.json() as Promise<Ad[]> : []).catch(() => []) as Promise<Ad[]>,
]);

const apiBase = import.meta.env.PUBLIC_API_BASE || 'http://localhost:3000';
const resolveMedia = (url?: string | null) => {
  if (!url) return null;
  if (url.startsWith('http')) return url;
  if (url.startsWith('/')) return `${apiBase}${url}`;
  return url;
};

function toEmbed(url?: string | null) {
  if (!url) return null;
  if (url.includes('youtube.com/watch')) {
    const id = url.split('v=')[1]?.split('&')[0];
    if (id) return `https://www.youtube.com/embed/${id}`;
  }
  return url;
}

const embed = toEmbed(article.video_embed_url);
const heroImage = resolveMedia(article.main_image_url);
const published = article.published_at
  ? new Date(article.published_at)
  : article.created_at
  ? new Date(article.created_at)
  : null;
const publishedLabel = published
  ? published.toLocaleString('es-CO', { dateStyle: 'medium', timeStyle: 'short' })
  : null;

const articleSlugValue = slug ?? '';
const pageUrl = Astro.url?.href ?? '';
const fallbackCommentUrl = `https://ctvbarranquilla.com/article/${articleSlugValue}`;
const commentHref = pageUrl || fallbackCommentUrl;
const adsClient = 'ca-pub-7829004963088413';
const articleMidAdSlot = import.meta.env.PUBLIC_ADS_SLOT_ARTICLE_MID || '';
const articleEndAdSlot = import.meta.env.PUBLIC_ADS_SLOT_ARTICLE_END || '';
const manualMidAd = adsMid?.[0];
const manualEndAd = adsEnd?.[0];
const midImage = manualMidAd?.image_url
  ? manualMidAd.image_url.startsWith('http')
    ? manualMidAd.image_url
    : `${apiBase}${manualMidAd.image_url}`
  : null;
const endImage = manualEndAd?.image_url
  ? manualEndAd.image_url.startsWith('http')
    ? manualEndAd.image_url
    : `${apiBase}${manualEndAd.image_url}`
  : null;
---

<Layout title={article.title} description={article.excerpt || article.title}>
  <article class="max-w-5xl mx-auto bg-white shadow rounded-lg overflow-hidden">
    {embed ? (
      <div class="aspect-video bg-black">
        <iframe src={embed} class="w-full h-full" allow="autoplay; encrypted-media" allowfullscreen title="Video"></iframe>
      </div>
    ) : (
      heroImage && <img src={heroImage} alt={article.title} class="w-full h-80 object-cover" loading="lazy" />
    )}
    <div class="p-6 space-y-4">
      <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500">
        <span class="text-ctv-accent font-bold uppercase">Noticia</span>
        {publishedLabel ? <span>{publishedLabel}</span> : null}
        <span>Vistas: {article.views_count}</span>
      </div>

      <h1 class="text-3xl md:text-4xl font-black leading-tight text-ctv-primary">{article.title}</h1>
      {article.excerpt && <p class="text-lg text-gray-700">{article.excerpt}</p>}

      <div class="prose prose-lg max-w-none text-gray-900 prose-headings:font-black prose-a:text-ctv-accent" set:html={article.content}></div>

      {(manualMidAd || articleMidAdSlot) && (
        <div class="my-6">
          {manualMidAd ? (
            manualMidAd.html_snippet ? (
              <div class="ad-shell ad-article_mid" set:html={manualMidAd.html_snippet}></div>
            ) : midImage ? (
              <a class="ad-shell ad-article_mid" href={manualMidAd.target_url || '#'} target="_blank" rel="noreferrer">
                <span class="ad-label">Publicidad</span>
                <img src={midImage} alt={manualMidAd.title} class="ad-frame" loading="lazy" style="object-fit:contain;" />
              </a>
            ) : null
          ) : (
            <AdSlot client={adsClient} slot={articleMidAdSlot} slotType="article_mid" />
          )}
        </div>
      )}

      {tags && tags.length > 0 && (
        <div class="flex flex-wrap gap-2 pt-2">
          {tags.map(tag => (
            <a href={`/tag/${tag.slug}`} class="text-xs bg-ctv-primary/10 text-ctv-primary px-2 py-1 rounded-full hover:bg-ctv-primary/20 transition">#{tag.name}</a>
          ))}
        </div>
      )}
    </div>
  </article>

  <section class="max-w-5xl mx-auto mt-10 space-y-4" id="comments">
    <h2 class="text-xl font-black text-ctv-primary uppercase">Comentarios</h2>
    <div class="bg-white shadow rounded-lg p-4">
      {disqusShortname ? (
        <DisqusThread
          client:only="react"
          shortname={disqusShortname}
          url={commentHref}
          identifier={articleSlugValue}
          title={article.title}
        />
      ) : (
        <p class="text-sm text-gray-600">Configura la variable <code>PUBLIC_DISQUS_SHORTNAME</code> para habilitar los comentarios.</p>
      )}
    </div>
  </section>

  <section class="max-w-5xl mx-auto mt-10">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-black text-ctv-primary uppercase">Relacionadas</h2>
    </div>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {related && related.length > 0 ? related.map(item => (
        <a href={`/article/${item.slug}`} class="bg-white shadow rounded-lg overflow-hidden hover:-translate-y-1 transition transform">
          {resolveMedia(item.main_image_url) && <img src={resolveMedia(item.main_image_url)!} alt={item.title} class="w-full h-32 object-cover" loading="lazy" />}
          <div class="p-4 space-y-1">
            <p class="text-xs uppercase tracking-wide text-ctv-accent font-bold">Noticia</p>
            <h4 class="font-semibold leading-tight line-clamp-2">{item.title}</h4>
          </div>
        </a>
      )) : (
        <p class="text-sm text-gray-500">No hay relacionadas.</p>
      )}
    </div>
  </section>

  {(manualEndAd || articleEndAdSlot) && (
    <section class="max-w-5xl mx-auto mt-8">
      <div class="bg-white shadow rounded-lg p-4">
        <h2 class="text-xl font-black text-ctv-primary uppercase mb-3">Publicidad</h2>
        {manualEndAd ? (
          manualEndAd.html_snippet ? (
            <div class="ad-shell ad-article_end" set:html={manualEndAd.html_snippet}></div>
          ) : endImage ? (
            <a class="ad-shell ad-article_end" href={manualEndAd.target_url || '#'} target="_blank" rel="noreferrer">
              <span class="ad-label">Publicidad</span>
              <img src={endImage} alt={manualEndAd.title} class="ad-frame" loading="lazy" style="object-fit:contain;" />
            </a>
          ) : null
        ) : (
          <AdSlot client={adsClient} slot={articleEndAdSlot} slotType="article_end" showLabel={false} />
        )}
      </div>
    </section>
  )}

  <script
    is:inline
    data-slug={articleSlugValue}
    data-comment-url={commentHref}
    data-disqus-shortname={disqusShortname}
  >
    const { dataset } = document.currentScript;
    const apiBase = import.meta.env.PUBLIC_API_BASE || 'http://localhost:3000';
    const articleSlug = dataset.slug || '';
    fetch(`${apiBase}/api/articles/${articleSlug}/view`, { method: 'POST' }).catch(() => {});
  </script>
</Layout>
